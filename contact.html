<!doctype html>
<html lang="en">

<head>
  <title>Contact Form</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="css/contact_style.css">

</head>

<body>
  <section class="ftco-section">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6 text-center mb-5">
          <h2 class="heading-section"></h2>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
          <div class="wrapper">
            <div class="row no-gutters">
              <div class="col-md-7 d-flex align-items-stretch">
                <div class="contact-wrap w-100 p-md-5 p-4">
                  <h3 class="mb-4">Get in touch</h3>
                  <div id="form-message-warning" class="mb-4"></div>
                  <div id="form-message-success" class="mb-4">
                    Your message was sent, thank you!
                  </div>
                  <form onsubmit="sendEmail(); reset(); return false;" id="contactForm" name="contactForm">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <input type="text" class="form-control" name="name" id="name" placeholder="Name">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <input type="email" class="form-control" name="email" id="email" placeholder="Email">
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <input type="text" class="form-control" name="subject" id="subject" placeholder="Subject">
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <textarea name="message" class="form-control" id="message" cols="30" rows="7" placeholder="Message"></textarea>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <input type="submit" value="Send Message" class="btn btn-primary">
                          <div class="submitting"></div>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="col-md-5 d-flex align-items-stretch">
                <div class="info-wrap bg-primary w-100 p-lg-5 p-4">
                  <h3 class="mb-4 mt-md-4">Contact us</h3>
                  <div class="dbox w-100 d-flex align-items-start">
                    <div class="icon d-flex align-items-center justify-content-center">
                      <span class="fa fa-map-marker"></span>
                    </div>
                    <div class="text pl-3">
                      <p><span>Address:</span> Coblitzallee 9-11 68163 Mannheim </p>
                    </div>
                  </div>
                  <div class="dbox w-100 d-flex align-items-center">
                    <div class="icon d-flex align-items-center justify-content-center">
                      <span class="fa fa-phone"></span>
                    </div>
                    <div class="text pl-3">
                      <p><span>Phone:</span> <a href="tel://1234567920">+49 1235 2355 98</a></p>
                    </div>
                  </div>
                  <div class="dbox w-100 d-flex align-items-center">
                    <div class="icon d-flex align-items-center justify-content-center">
                      <span class="fa fa-paper-plane"></span>
                    </div>
                    <div class="text pl-3">
                      <p><span>Email:</span> <a href="mailto:alessandro.avanzato@outlook.de">info@speaq.com</a></p>
                    </div>
                  </div>
                  <div class="dbox w-100 d-flex align-items-center">
                    <div class="icon d-flex align-items-center justify-content-center">
                      <span class="fa fa-globe"></span>
                    </div>
                    <div class="text pl-3">
                      <p><span>Back to Website</span> <a href="index.html">speaq.com</a></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="https://smtpjs.com/v3/smtp.js"></script>
  <script>
    const express = require("express");
    const nodemailer = require("nodemailer");
    const multiparty = require("multiparty");
    require("dotenv").config();

    // instantiate an express app
    const app = express();

    //make the contact page the the first page on the app
    app.route("/").get(function(req, res) {
      res.sendFile(process.cwd() + "/public/index.html");
    });

    //port will be 5000 for testing
    const PORT = process.env.PORT || 5000;
    app.listen(PORT, () => {
      console.log(`Listening on port ${PORT}...`);
    });
    const transporter = nodemailer.createTransport({
      host: "smtp.live.com", //replace with your email provider
      port: 587,
      auth: {
        user: "alessandroavanzato@hotmail.de",
        pass: 
      },
    });

    // verify connection configuration
    transporter.verify(function(error, success) {
      if (error) {
        console.log(error);
      } else {
        console.log("Server is ready to take our messages");
      }
    });
    app.post("/send", (req, res) => {
      //1.
      let form = new multiparty.Form();
      let data = {};
      form.parse(req, function(err, fields) {
        console.log(fields);
        Object.keys(fields).forEach(function(property) {
          data[property] = fields[property].toString();
        });

        //2. You can configure the object however you want
        const mail = {
          from: data.name,
          to: process.env.EMAIL,
          subject: data.subject,
          text: `${data.name} <${data.email}> \n${data.message}`,
        };

        //3.
        transporter.sendMail(mail, (err, data) => {
          if (err) {
            console.log(err);
            res.status(500).send("Something went wrong.");
          } else {
            res.status(200).send("Email successfully sent to recipient!");
          }
        });
      });
    });



    //get the form by its id
    const form = document.getElementById("contactForm");

    //1.
    const formEvent = form.addEventListener("submit", (event) => {
      event.preventDefault();

      //2.
      let mail = new FormData(form);

      //3.
      sendMail(mail);
    })

    const sendMail = (mail) => {
      //1.
      fetch("/send", {
        method: "post", //2.
        body: mail, //3.

      }).then((response) => {
        return response.json();
      });
    };



    /*
      function sendEmail() {
        Email.send({
          secureToken:"6d7d2281-5b9c-4d71-8504-d0f39c845c29",
          To: "ale.ava0208@gmail.com",
          From: document.getElementByID("email").value,
          Subject: "This is the subject",
          Body: "And this is the body"
        }).then(
          message => alert(message)
        );
      } */
  </script>

</body>

</html>
